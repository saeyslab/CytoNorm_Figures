---
title: "Figures CytofNorm Paper - extra datasets"
output: html_notebook
---

# Figures CytofNorm Paper - extra datasets

## Setup

Load the required libraries

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(flowCore))
suppressPackageStartupMessages(library(ncdfFlow))
suppressPackageStartupMessages(library(ggcyto))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(pheatmap))
suppressPackageStartupMessages(library(FlowSOM))
suppressPackageStartupMessages(library(CytofNorm))
```

Directory to save results to

```{r}
results <- "results_additional_datasets"
if(!dir.exists(results)) dir.create(results)
```

Set the path to the data files and extract the metadata from the filenames.

```{r}
dataset <- "CS"
dir <- "../data/CS/control"
manual_file <- "../data/CS/manual/170111_manualCS.Rdata"
files <- list.files(dir, pattern="CS[0-9_]*_[Unstim|IFNa_LPS]*_Control_CD45_CD66-.fcs$")
df <- data.frame(File = files,
                 Plate = as.factor(str_match(files, "(CS[0-9]*)")[, 2]),
                 Stim = as.factor(str_match(files, "[0-9]_([^0-9]*)_Control")[, 2]),
                 stringsAsFactors = FALSE)
rownames(df) <- df$File
df
```

```{r}
dataset <- "Gates"
dir <- "../data/Gates"
manual_file <- "../data/Gates/manual/170112_manualGates.Rdata"
files <- list.files(dir, pattern="Gates_PTLG[0-9]*_[Unstim|IFNa_LPS]*_Control.fcs$")
df <- data.frame(File = files,
                 Plate = as.factor(str_match(files, "(PTLG[0-9]*)")[, 2]),
                 Stim = as.factor(str_match(files, "[0-9]_(.*)_Control")[, 2]),
                 stringsAsFactors = FALSE)
rownames(df) <- df$File
df
```

Read the marker names from the first file.  
Identify the markers of interest, ordered alphabetically, surface markers first.
```{r}
o <- capture.output(ff <- read.FCS(file.path(dir, df$File[1])))
marker_names <- get_markers(ff, colnames(ff))

surface_markers <- c(grep("CD", marker_names),
                     grep("CC", marker_names),
                     grep("HLADR", marker_names),
                     grep("TCRgd", marker_names))

# Leave out CD19 because of issues with the staining for this marker
norm_markers <- c(48, 46, 43, 45, 20, 16, 21, 19, 22, 50, 47, 40, 44, 33,  # 17,
                  11, 18, 51, 14, 23, 32, 10, 49, 27, 24, 31, 42, 37, 39, 34, 
                  41, 26, 30, 28, 29, 25, 35)
surface_markers <- surface_markers[which(surface_markers %in% norm_markers)]

transformList <- transformList(colnames(ff)[norm_markers], 
                               cytofTransform)
transformList.reverse <- transformList(colnames(ff)[norm_markers], 
                                       cytofTransform.reverse)

print(marker_names[surface_markers])
```

Load the manual mapping of the data.  
See ExtractManualGating_CytofNorm.R file to generate the RDS file.
```{r}
load(manual_file)
cell_types <- c("All", levels(manual_list[[1]])[-1])
print(cell_types)
```

## Run normalization on the samples

### CytofNorm normalization

Training

```{r}
train_data <- df %>% 
  dplyr::filter(Stim == "IFNa_LPS")
  
t <- system.time(capture.output(
  model <- CytofNorm.train(files = file.path(dir, 
                                             train_data$File),
                           labels = train_data$Plate,
                           channels = names(marker_names)[surface_markers],
                           transformList = transformList,
                           FlowSOM.params = list(xdim = 10,
                                                 ydim = 10,
                                                 nClus = 30,
                                                 nCells = 1000000),
                           normMethod.train = QuantileNorm.train,
                           normParams = list(nQ = 21,
                                             spar = 0.5),
                           seed = 1)))

print(t)
saveRDS(model,
        file = file.path(results,
                         paste0(dataset, "_CytofNorm.rds")))
```

Normalization

```{r}
model <- readRDS(file.path(results,
                             paste0(dataset, "_CytofNorm.rds")))
test_data <- df %>% 
  dplyr::filter(Stim == "Unstim")
  
t <- system.time(capture.output(
  CytofNorm.normalize(model = model,
                      files = file.path(dir, test_data$File),
                      labels = test_data$Plate,
                      transformList = transformList,
                      transformList.reverse = transformList.reverse,
                      outputDir = paste0("CytofNorm_ExtraDatasets_", dataset),
                      normMethod.normalize = QuantileNorm.normalize)))
print(t)
```

### Normalization without clustering

```{r}
t <- system.time(capture.output(
  model_q <- QuantileNorm.train(files = file.path(dir, train_data$File),
                                labels = train_data$Plate,
                                channels = names(marker_names)[surface_markers],
                                transformList = transformList)))
print(t)

saveRDS(model_q,
        file = file.path(results,
                         paste0(dataset, "_QuantileNorm.rds")))
```

```{r}
t <- system.time(capture.output(
  model_mm <- MinMaxNorm.train(files = file.path(dir, 
                                                 train_data$File),
                               labels = train_data$Plate,
                               channels = names(marker_names)[surface_markers],
                               transformList = transformList,
                               minmax_q = c(0.001, 0.999))))
print(t)

saveRDS(model_mm,
        file = file.path(results,
                         paste0(dataset, "_MinMaxNorm.rds")))
```

Normalizing 
```{r}
t <- system.time(capture.output(
  QuantileNorm.normalize(model = model_q,
                         files = file.path(dir, test_data$File),
                         labels = test_data$Plate,
                         transformList = transformList,
                         transformList.reverse = transformList.reverse,
                         outputDir = paste0("QuantileNorm_ExtraDatasets_", dataset))))

print(t)

t <- system.time(capture.output(
  MinMaxNorm.normalize(model = model_mm,
                       files = file.path(dir, test_data$File),
                       labels = test_data$Plate,
                       transformList = transformList,
                       transformList.reverse = transformList.reverse,
                       outputDir = paste0("MinMaxNorm_ExtraDatasets_", dataset))))
print(t)
```

## Evaluation

```{r}
methods <- c("Original", 
             "CytofNorm",  
             "QuantileNorm", 
             "MinMaxNorm")

emds <- list()
for (method in methods) {
  print(paste0("Evaluating ", method))
  if(method == "Original") {
    eval_dir = dir
    eval_prefix = ""
  } else {
    eval_dir = paste0(method, "_ExtraDatasets_", dataset)
    eval_prefix = "Norm_"
  }
  o <- capture.output(
    emds[[method]] <- emdEvaluation(file.path(eval_dir, 
                                           paste0(eval_prefix,
                                                  test_data$File)),
                                 transformList = transformList,
                                 manual = manual_list,
                                 markers = names(marker_names)[surface_markers]))
}

saveRDS(emds,
        file = file.path(results, paste0(dataset, "_emds.rds")))
```


```{r}
emds <- readRDS(file.path(results,
                          paste0(dataset, "_emds.rds")))
emds_g <- lapply(names(emds), function(method){
  col_name <- paste0("EMD_",method)
  gather(data.frame(Population = rownames(emds[[method]]), 
                    emds[[method]])[-1,], 
         "Channel", col_name, -"Population")  %>% 
    magrittr::set_colnames(c("Population", "Channel", col_name))
}) %>% magrittr::set_names(names(emds))

emds_g <- cbind(emds_g[[1]][,c(1,2)],
                do.call(cbind, lapply(emds_g, function(x) x[,3])))
rownames(emds_g) <- paste0(emds_g[,1], "_", get_markers(ff, emds_g[,2]))


reduction <- list()
for(method in methods){
  affected <- (emds_g[,method] > 2) | (emds_g[ ,"Original"] > 2)
  reduction[[method]] <- data.frame(population_marker = rownames(emds_g)[affected],
                                    reduction = ((emds_g[,"Original"] - emds_g[,method]) /
                                                   emds_g[,"Original"])[affected],
                                    method = method)
}
reduction <- do.call(rbind, reduction)

reduction <- cbind("mean" = tapply(reduction$reduction, 
                                   reduction$method, 
                                   mean),
                   "sd" = tapply(reduction$reduction,
                                 reduction$method,
                                 sd))

                           
print(reduction)
```

## Evaluation plots

```{r}
plot_emds <- function(exp_1, exp_2, emds_g){
  emds_g$affected <- emds_g[,exp_1] > 2 | emds_g[,exp_2] > 2
  
  p <- ggplot(emds_g) +
    geom_point(aes_string(x = exp_1, 
                          y = exp_2, 
                          col = "affected")) +
    geom_rect(data = data.frame(xmin = 0, xmax = 2, ymin = 0, ymax = 2),
              aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
              fill = "#555555", alpha = 0.3) +
    scale_x_continuous(limits = c(0, 15)) +
    scale_y_continuous(limits = c(0, 15)) +
    scale_color_manual(values = c("FALSE" = "grey", "TRUE" = "black")) +
    ggplot2::geom_abline(lwd = 1.5) +
    coord_fixed() +
    ggtitle("Average change: ", 
            paste0(round(reduction[exp_1,"mean"], 4), " (Â±", round(reduction[exp_1,"sd"],4), ")")) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme_minimal()
  emds_g$affected <- NULL
  return(p)
}
```

# Figure 8
```{r fig.width=12, fig.height = 4}
plots <- list()
for(method in methods[2:4]){
  plots[[method]] <- plot_emds(method, 
                               "Original",
                               emds_g)
}
do.call(grid.arrange, c(plots, list(nrow = 1)))
```
